/*
 * elm327.c
 *
 *  Created on: Nov 9, 2025
 *      Author: jvmen
 */


// inicia ELM327
void ELM327_Init_Debug(UART_HandleTypeDef *huart)
{
    //const char *init_cmds[] = {"ATZ\r", "ATE0\r", "ATL0\r", "ATS0\r", "ATSP0\r"};
    const char *init_cmds[] = {"ATZ\r"};
    for (uint8_t i = 0; i < sizeof(init_cmds)/sizeof(init_cmds[0]); i++)
    {
    	ELM327_SendCmd(huart, init_cmds[i]);
    	HAL_Delay(500);
    }

    HAL_UART_Transmit(&hlpuart1, (uint8_t*)"ELM327 inicializado com sucesso!\r\n", 35, HAL_MAX_DELAY);
}

/* Conversão hexadecimal -> byte */
uint8_t hexToByte(const char *hex)
{
    uint8_t val = 0;
    for (int i = 0; i < 2; i++)
    {
        char c = hex[i];
        val <<= 4;
        if (c >= '0' && c <= '9') val |= c - '0';
        else if (c >= 'A' && c <= 'F') val |= c - 'A' + 10;
        else if (c >= 'a' && c <= 'f') val |= c - 'a' + 10;
    }
    return val;
}

void OBD_SendCommand(const char *pid)
{
    char cmd[8];

    /* Monta o comando com '\r' no final */
    sprintf(cmd, "%s\r", pid);

    /* Envia pela UART1 (para o ELM327 / veículo) */
    HAL_UART_Transmit(&huart1, (uint8_t*)cmd, strlen(cmd), HAL_MAX_DELAY);

    /* Mostra no terminal o comando enviado */
    char msg[32];
    sprintf(msg, "\r\n> Enviado: %s", pid);
    HAL_UART_Transmit(&hlpuart1, (uint8_t*)msg, strlen(msg), HAL_MAX_DELAY);
}
